<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>电商平台 - 优购商城</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.8/axios.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF4400',
            secondary: '#333333',
            light: '#F5F5F5'
          },
          fontFamily: {
            sans: ['PingFang SC', 'Helvetica Neue', 'Arial', 'sans-serif']
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .nav-item-hover {
        /* 保留您原有的 hover 效果定义 */
        @apply relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full;
      }

      /* 【修复点】：重新定义 #main-nav a.active 样式，确保它使用 Tailwind 类并只添加高亮 */
      #main-nav a.active {
        /* 使用 primary 颜色、加粗、并添加底部线条 */
        @apply text-primary font-bold border-b-2 border-primary;
      }

      .btn-primary {
        @apply bg-primary text-white px-4 py-2 rounded-md transition-all hover:bg-primary/90 active:scale-95;
      }
      .banner-shadow { @apply shadow-md; }
      .category-card {
        @apply bg-white rounded-lg p-4 text-center hover:shadow-md transition-shadow cursor-pointer;
      }
      .product-card-shadow { @apply shadow-md hover:shadow-lg transition-shadow; }
      /* 隐藏滚动条 */
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-secondary">
<div id="app" class="min-h-screen flex flex-col">
  <header id="header-container"></header>

  <main class="flex-grow">
    <div id="banner-container" class="relative overflow-hidden">
      <div class="banner-loading h-64 md:h-96 flex items-center justify-center bg-white">
        <i class="fa fa-spinner fa-spin text-4xl text-primary"></i>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fa fa-th-list text-primary mr-2"></i> 热门分类
      </h2>
      <div id="category-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div class="col-span-full text-center py-8">
          <i class="fa fa-spinner fa-spin text-2xl text-primary mb-2"></i>
          <p class="text-gray-500">加载分类中...</p>
        </div>
      </div>
    </div>

    <div id="recommend-section" class="container mx-auto px-4 py-8 md:py-12 bg-white rounded-lg my-8">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fa fa-fire text-primary mr-2"></i> 热门推荐
      </h2>
      <div id="recommend-loading" class="py-20 text-center">
        <i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i>
        <p class="text-gray-600">正在加载推荐商品...</p>
      </div>
      <div id="recommend-error" class="hidden py-20 text-center">
        <i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
        <p class="text-gray-600" id="recommend-error-msg">商品加载失败</p>
        <button id="recommend-retry" class="btn-primary mt-4">重新加载</button>
      </div>
      <div id="recommend-product-container" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
      <div id="recommend-more-btn-container" class="hidden text-center mt-10">
        <a href="/pages/product/list.html" class="btn-primary inline-flex items-center">
          查看全部商品 <i class="fa fa-arrow-right ml-2"></i>
        </a>
      </div>
    </div>

  </main>

  <footer id="footer-container"></footer>
</div>

<script src="/assets/js/component-loader.js"></script>
<script src="/assets/js/utils.js"></script>
<script>
  let bannerList = [];
  let categoryList = [];
  let recommendList = [];
  let currentBannerIndex = 0; // 追踪当前轮播图索引
  let bannerInterval = null; // 存储定时器ID

  // 轮播图自动切换间隔（毫秒）
  const AUTOPLAY_INTERVAL = 4000;

  // DOM加载完成后初始化
  document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM加载完成，开始初始化');
    // 加载头部/底部组件
    // 注意：loadComponent 是异步的，不能保证所有组件同时完成
    loadComponent('layout/header.html', '#header-container', initHeaderEvents);
    loadComponent('layout/footer.html', '#footer-container');

    // 【移除加载：common/about.html 的调用已移除】

    // 延迟执行，确保axios已挂载
    setTimeout(() => {
      console.log('✅ 开始加载轮播图、分类和推荐商品');
      fetchBannerData();
      fetchCategoryData();
      fetchRecommendData();

      // 确保高亮逻辑被调用
      if (typeof highlightCurrentNav === 'function') {
        highlightCurrentNav();
      }
    }, 100);

    // 绑定重试按钮事件
    document.getElementById('recommend-retry')?.addEventListener('click', fetchRecommendData);
  });

  /**
   * 启动轮播图自动播放
   */
  function startAutoplay() {
    if (bannerInterval) clearInterval(bannerInterval);
    if (bannerList.length <= 1) return; // 只有一个或没有banner时，不开启自动播放

    const bannerContainer = document.querySelector('#banner-container > div.flex');
    if (!bannerContainer) return; // 防止找不到元素

    // 监听滚动结束事件，用于手动滚动后同步指示器和重置定时器
    let scrollTimer;
    bannerContainer.addEventListener('scroll', () => {
      clearTimeout(scrollTimer);
      clearTimeout(bannerInterval); // 用户手动滚动时，停止自动播放

      scrollTimer = setTimeout(() => {
        // 计算当前显示的banner索引 (滚动位置 / banner宽度 + 0.5 四舍五入)
        const newIndex = Math.round(bannerContainer.scrollLeft / bannerContainer.offsetWidth);
        if (newIndex !== currentBannerIndex) {
          updateIndicators(newIndex);
          currentBannerIndex = newIndex;
        }
        startAutoplayTimer(); // 滚动结束后重新启动定时器
      }, 150); // 滚动停止后150ms判断
    });

    startAutoplayTimer();
  }

  /**
   * 启动定时器
   */
  function startAutoplayTimer() {
    bannerInterval = setInterval(() => {
      const nextIndex = (currentBannerIndex + 1) % bannerList.length;
      switchBanner(nextIndex, true); // 自动播放模式
    }, AUTOPLAY_INTERVAL);
  }


  /**
   * 轮播图加载
   */
  function fetchBannerData() {
    console.log('===== 轮播图接口请求开始 =====');
    axios.get('/api/banner/list')
            .then(res => {
              const data = res.data.data || res.data;

              if (Array.isArray(data) && data.length > 0) {
                bannerList = data;
                renderBanner();
                // 确保 DOM 渲染完成后才开始自动播放
                setTimeout(startAutoplay, 50);
              } else {
                renderDefaultBanner();
              }
            })
            .catch(err => {
              console.error('接口请求错误详情：', err);
              renderDefaultBanner();
            });
  }

  /**
   * 渲染轮播图 - 修复版本 (修复了图片路径)
   */
  function renderBanner() {
    const container = document.getElementById('banner-container');

    // 过滤掉没有有效图片的banner
    const validBannerList = bannerList.filter(banner => banner.image_url || banner.imageUrl || banner.url || banner.image);
    if (!validBannerList || validBannerList.length === 0) {
      renderDefaultBanner();
      return;
    }

    bannerList = validBannerList; // 更新为有效的banner列表

    console.log('✅ 开始渲染轮播图，使用', bannerList.length, '个banner');

    // 动态生成轮播图HTML
    let bannerHTML = '<div class="flex h-64 md:h-96 overflow-x-auto scrollbar-hide snap-x snap-mandatory">';

    bannerList.forEach((banner, index) => {
      const imageUrl = banner.image_url || banner.imageUrl || banner.url || banner.image || '';

      // 修复图片路径：假设静态文件路径为 /assets/
      const fullImageUrl = imageUrl.startsWith('http')
              ? imageUrl
              : `/assets/image/banner/${imageUrl.split('/').pop()}`; // 修正为 /assets/image/banner/

      // 默认图片路径也使用 /assets/
      const errorFallbackUrl = '/assets/image/banner/banner-default.png';

      bannerHTML += `
          <div class="min-w-full h-full snap-start relative" id="banner-${index}">
            <img
              src="${fullImageUrl}"
              class="w-full h-full object-cover"
              alt="${banner.title || `轮播图${index + 1}`}"
              onerror="this.onerror=null;this.src='${errorFallbackUrl}'"
            />
            ${banner.title ? `
              <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-4 text-white">
                <h3 class="text-lg font-bold">${banner.title}</h3>
              </div>
            ` : ''}
          </div>
        `;
    });

    bannerHTML += '</div>';

    // 添加指示器（如果有多个banner）
    if (bannerList.length > 1) {
      bannerHTML += `
          <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2" id="banner-indicators">
            ${bannerList.map((_, index) => `
              <span
                class="w-2 h-2 rounded-full cursor-pointer ${index === 0 ? 'bg-primary' : 'bg-white/50'}"
                onclick="switchBanner(${index})"
              ></span>
            `).join('')}
          </div>
        `;
    }

    container.innerHTML = bannerHTML;
    console.log('✅ 轮播图渲染完成，使用了', bannerList.length, '个banner');
  }

  /**
   * 渲染默认轮播图
   */
  function renderDefaultBanner() {
    const container = document.getElementById('banner-container');
    if (container) {
      // 使用基于根目录的绝对路径 /assets/
      const defaultImageUrl = '/assets/image/banner/banner-default.png';
      container.innerHTML = `
          <img
            src="${defaultImageUrl}"
            alt="默认轮播图"
            class="w-full h-64 md:h-96 object-cover banner-shadow"
          >
        `;
      console.log('✅ 渲染默认轮播图完成，路径：', defaultImageUrl);
    }
  }

  /**
   * 切换轮播图 (手动点击指示器或自动播放调用)
   */
  function switchBanner(index, isAuto = false) {
    const bannerContainer = document.querySelector('#banner-container > div.flex');
    if (!bannerContainer || index < 0 || index >= bannerList.length) {
      return;
    }

    // 如果是手动点击，停止自动播放，并重置定时器
    if (!isAuto) {
      if (bannerInterval) clearInterval(bannerInterval);
      startAutoplayTimer(); // 手动切换后重置定时器，从头开始计时
    }

    currentBannerIndex = index; // 更新当前索引

    // 计算滚动距离
    const bannerWidth = bannerContainer.offsetWidth;
    bannerContainer.scrollTo({
      left: bannerWidth * index,
      behavior: 'smooth'
    });

    // 更新指示器状态
    updateIndicators(index);
  }

  /**
   * 更新指示器样式
   */
  function updateIndicators(activeIndex) {
    const indicators = document.querySelectorAll('#banner-indicators span');
    indicators.forEach((item, i) => {
      item.classList.toggle('bg-primary', i === activeIndex);
      item.classList.toggle('bg-white/50', i !== activeIndex);
    });
  }

  /**
   * 分类加载
   */
  function fetchCategoryData() {
    console.log('===== 分类接口请求开始 =====');
    axios.get('/api/category/list')
            .then(res => {
              // 注意：分类接口返回的是包装结构，需要读取 res.data.data
              const data = res.data.data;
              if (res.data.code === 200 && Array.isArray(data) && data.length > 0) {
                categoryList = data;
                renderCategory();
              } else {
                renderDefaultCategory();
              }
            })
            .catch(err => {
              console.error('❌ 分类接口请求失败：', err);
              renderDefaultCategory();
            });
  }

  /**
   * 渲染分类
   */
  function renderCategory() {
    const container = document.getElementById('category-container');
    if (!container) return;
    container.innerHTML = '';

    categoryList.forEach(cate => {
      container.innerHTML += `
          <div class="category-card" onclick="jumpToCategoryList('${cate.id}')">
            <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-primary/10 flex items-center justify-center">
              <i class="fa ${cate.icon || 'fa-mobile'} text-2xl text-primary"></i>
            </div>
            <h3 class="font-medium">${cate.name || '未知分类'}</h3>
          </div>
        `;
    });
  }

  /**
   * 渲染默认分类
   */
  function renderDefaultCategory() {
    const container = document.getElementById('category-container');
    if (!container) return;
    container.innerHTML = '';

    const defaultCates = [
      { name: '手机数码', icon: 'fa-mobile' },
      { name: '电脑办公', icon: 'fa-laptop' },
      { name: '家用电器', icon: 'fa-tv' },
      { name: '服装鞋帽', icon: 'fa-shopping-bag' },
      { name: '美妆护肤', icon: 'fa-gift' },
      { name: '食品生鲜', icon: 'fa-apple' }
    ];

    defaultCates.forEach(cate => {
      container.innerHTML += `
          <div class="category-card" onclick="jumpToCategoryList('')">
            <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-primary/10 flex items-center justify-center">
              <i class="fa ${cate.icon} text-2xl text-primary"></i>
            </div>
            <h3 class="font-medium">${cate.name}</h3>
          </div>
        `;
    });
  }

  /**
   * 分类跳转 - 修正参数名
   */
  function jumpToCategoryList(categoryId) {
    const url = `/pages/product/list.html${categoryId ? `?category_id=${categoryId}` : ''}`;
    window.location.href = url;
  }

  /**
   * 推荐商品加载
   */
  function fetchRecommendData() {
    console.log('===== 推荐商品接口请求开始 (修正为 /api/product/list?is_recommend=1&size=5) =====');
    const loadingEl = document.getElementById('recommend-loading');
    const errorEl = document.getElementById('recommend-error');
    const productContainer = document.getElementById('recommend-product-container');
    const moreBtnContainer = document.getElementById('recommend-more-btn-container');

    if (loadingEl) loadingEl.classList.remove('hidden');
    if (errorEl) errorEl.classList.add('hidden');
    if (productContainer) productContainer.classList.add('hidden');
    if (moreBtnContainer) moreBtnContainer.classList.add('hidden');

    axios.get('/api/product/list?is_recommend=1&size=5')
            .then(res => {
              if (res.data.code === 200) {
                // 解析分页结构中的 list 字段
                const data = res.data.data.list;

                if (Array.isArray(data) && data.length > 0) {
                  recommendList = data;
                  renderRecommendProducts();
                } else {
                  if (loadingEl) loadingEl.classList.add('hidden');
                  console.log('⚠️ 推荐商品接口返回数据为空');
                  if (productContainer) {
                    productContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">暂无推荐商品。</p>';
                    productContainer.classList.remove('hidden');
                  }
                }
              } else {
                if (loadingEl) loadingEl.classList.add('hidden');
                if (errorEl) errorEl.classList.remove('hidden');
                document.getElementById('recommend-error-msg').textContent = res.data.msg || '推荐商品数据异常。';
              }
            })
            .catch(err => {
              console.error('❌ 推荐商品接口请求失败：', err);
              if (loadingEl) loadingEl.classList.add('hidden');
              if (errorEl) errorEl.classList.remove('hidden');
              document.getElementById('recommend-error-msg').textContent = '商品加载失败，请检查网络或后端服务。';
            });
  }


  /**
   * 渲染推荐商品
   */
  function renderRecommendProducts() {
    const loadingEl = document.getElementById('recommend-loading');
    const productContainer = document.getElementById('recommend-product-container');
    const moreBtnContainer = document.getElementById('recommend-more-btn-container');

    if (loadingEl) loadingEl.classList.add('hidden');
    if (!productContainer) return;

    productContainer.innerHTML = ''; // 清空原有内容

    recommendList.forEach(product => {
      // 修复图片路径：假设推荐商品图片路径为 /assets/image/product/ 或直接使用 main_image
      const productImageUrl = product.main_image || product.image || '/assets/image/product/default.png'; // 假设图片字段是 image 或 main_image
      const defaultImageUrl = '/assets/image/product/default.png';


      productContainer.innerHTML += `
                <a href="/pages/product/detail.html?id=${product.id}" class="block bg-white rounded-lg overflow-hidden product-card-shadow">
                    <img
                        src="${productImageUrl}"
                        alt="${product.name}"
                        class="w-full h-48 object-cover"
                        onerror="this.onerror=null;this.src='${defaultImageUrl}'"
                    >
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-secondary truncate mb-1">${product.name}</h3>
                        <p class="text-gray-500 text-sm mb-2">${product.description || '暂无描述'}</p>
                        <div class="flex items-end justify-between">
                            <span class="text-primary text-xl font-bold">¥${(product.price || 0).toFixed(2)}</span>
                            <button class="bg-primary text-white text-sm px-3 py-1 rounded-full hover:bg-primary/90 transition-colors">
                                立即购买
                            </button>
                        </div>
                    </div>
                </a>
            `;
    });

    productContainer.classList.remove('hidden');
    if (moreBtnContainer) moreBtnContainer.classList.remove('hidden');
    console.log('✅ 推荐商品渲染完成，共', recommendList.length, '个');
  }

  /**
   * 头部事件初始化
   */
  function initHeaderEvents() {
    const menuBtn = document.querySelector('.fa-bars')?.parentElement;
    if (menuBtn) {
      menuBtn.addEventListener('click', () => alert('移动端菜单展开'));
    }

    // 搜索输入框事件绑定
    const searchInput = document.querySelector('#header-container #search-input');
    if (searchInput && typeof searchProduct === 'function') {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchProduct(); // 调用 utils.js 中定义的搜索函数
        }
      });
    }

    // 确保导航栏高亮逻辑在 header 组件加载完成后被执行
    if (typeof highlightCurrentNav === 'function') {
      highlightCurrentNav();
    }
  }
</script>
</body>
</html>