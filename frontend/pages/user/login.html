<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户登录 - 优购商城</title>
  <!-- 保留Tailwind和Font Awesome（核心样式） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- 修复1：注释不存在的CSS（避免404干扰） -->
  <!-- <link rel="stylesheet" href="/assets/css/global.css"> -->
  <!-- <link rel="stylesheet" href="/assets/css/pages/user.css"> -->

  <!-- 修复2：改用国内可访问的axios CDN（解决连接超时） -->
  <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.8/axios.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#FF4400', secondary: '#333333' },
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 font-sans">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- 公共头部 -->
    <header id="header-container"></header>

    <!-- 登录表单 -->
    <main class="flex-grow container mx-auto px-4 py-12">
      <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold mb-6 text-center">用户登录</h2>

        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-gray-700 mb-2" for="username">
              <i class="fa fa-user mr-1"></i> 用户名
            </label>
            <input type="text" id="username" name="username"
                  class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                  required>
          </div>

          <div>
            <label class="block text-gray-700 mb-2" for="password">
              <i class="fa fa-lock mr-1"></i> 密码
            </label>
            <input type="password" id="password" name="password"
                  class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                  required>
          </div>

          <div class="flex items-center justify-between">
            <label class="flex items-center">
              <input type="checkbox" class="mr-2"> 记住我
            </label>
            <a href="/pages/user/forgot.html" class="text-primary hover:underline">忘记密码？</a>
          </div>

          <button type="submit" class="w-full bg-primary text-white py-3 rounded-md hover:bg-primary/90 transition-colors">
            登录
          </button>
        </form>

        <div class="mt-6 text-center">
          <p>还没有账号？<a href="/pages/user/register.html" class="text-primary hover:underline">立即注册</a></p>
        </div>
      </div>
    </main>

    <!-- 公共底部 -->
    <footer id="footer-container"></footer>
  </div>

  <!-- 先引入loader，再写业务逻辑 -->
  <script src="/assets/js/component-loader.js"></script>
  <script>
    // 先验证axios是否加载成功（调试用）
    console.log('axios是否存在：', typeof axios); // 正常应该显示function

    document.addEventListener('DOMContentLoaded', () => {
      // 加载头部/底部（若loader报错，可先注释，优先保证登录）
      try {
        loadComponent('layout/header.html', '#header-container');
        loadComponent('layout/footer.html', '#footer-container');
      } catch (e) {
        console.log('加载头部/底部失败，不影响登录：', e);
      }

      // 登录表单提交
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim(); // 去除空格
        const password = document.getElementById('password').value.trim(); // 去除空格

        // 空值校验（提前拦截）
        if (!username) {
          alert('请输入用户名！');
          return;
        }
        if (!password) {
          alert('请输入密码！');
          return;
        }

        try {
          console.log('开始请求登录接口，参数：', {username, password});
          // 直接请求后端接口（确认后端地址是127.0.0.1:3000）
          const res = await axios.post('http://127.0.0.1:3000/api/user/login', {
            username: username,
            password: password
          });

          // 解析响应（兼容后端结构）
          const result = res.data || res;
          console.log('接口返回结果：', result);

          if (result.code === 200) {
            localStorage.setItem('token', result.data.token || '');
            alert('登录成功！即将跳转到首页');
            window.location.href = 'http://127.0.0.1:3000/'; // 强制指定后端地址
          } else {
            alert('登录失败：' + (result.msg || '未知错误'));
          }
        } catch (err) {
          console.error('登录请求详细错误：', err);
          // 精准判断错误类型
          if (err.message.includes('Network Error')) {
            alert('网络错误！请检查：\n1. 后端服务是否启动（app.py）\n2. 地址是否是127.0.0.1:3000');
          } else if (err.response) {
            // 后端返回了错误（比如401）
            alert('登录失败：' + (err.response.data?.msg || '账号/密码错误'));
          } else {
            alert('登录失败：' + err.message);
          }
        }
      });
    });
  </script>
</body>
</html>