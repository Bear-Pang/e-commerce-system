<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商品列表 - 优购商城</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#FF4400', secondary: '#333333' },
          // 我们直接使用 tailwind 原生 gap-6，不再依赖 gap-card-gap
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .filter-item-active { @apply bg-primary text-white; }
      /* 增强卡片悬停效果，与主页一致 */
      .product-card-shadow { @apply shadow-md hover:shadow-lg transition-all duration-300; }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-secondary">
<div id="app" class="min-h-screen flex flex-col">
  <header id="header-container"></header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <div id="loading-container" class="bg-white rounded-lg p-8 text-center py-20">
      <i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i>
      <p class="text-gray-600">正在加载商品列表...</p>
    </div>

    <div id="error-container" class="hidden bg-white rounded-lg p-8 text-center py-20">
      <i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
      <p class="text-gray-600" id="error-message">商品列表加载失败</p>
      <button id="retry-btn" class="btn-primary mt-4">重新加载</button>
    </div>

    <div id="list-container" class="hidden">
      <div class="flex flex-col md:flex-row gap-6">
        <div class="w-full md:w-64 shrink-0">
          <div id="category-filter" class="bg-white p-4 rounded-lg shadow-sm mb-6 sticky top-4">
            <h3 class="font-bold mb-4 border-b pb-2">商品分类</h3>
          </div>
        </div>

        <div class="flex-1">
          <div class="bg-white p-4 rounded-lg mb-6 shadow-sm flex flex-wrap gap-2" id="filter-tags">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="product-list">
          </div>

          <div class="mt-8 text-center" id="pagination-container"></div>
        </div>
      </div>
    </div>
  </main>

  <footer id="footer-container"></footer>
</div>

<script src="/assets/js/component-loader.js"></script>

<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.8/axios.min.js"></script>

<script>
  let productList = [];
  let pagination = { page: 1, size: 10, total: 0, totalPages: 0 };
  let currentFilter = { categoryId: '', keyword: '', isPromotion: false };

  document.addEventListener('DOMContentLoaded', function() {
    initFilterFromUrl();
    loadComponent('layout/header.html', '#header-container', initHeaderEvents);
    loadComponent('layout/footer.html', '#footer-container');
    fetchCategoryData();
    fetchProductList();

    document.getElementById('retry-btn').addEventListener('click', fetchProductList);
  });

  // ================= 核心渲染逻辑 (已整合之前的优化) =================

  function renderProductList() {
    const container = document.getElementById('product-list');

    if (productList.length === 0) {
      container.innerHTML = '<div class="col-span-full text-center py-20 text-gray-500 bg-white">暂无商品数据</div>';
      return;
    }

    let productHtml = '';
    productList.forEach(product => {
      // 1. 图片路径处理 (智能补全)
      let rawImage = product.main_image || product.image || '';
      let imageUrl = rawImage;
      if (rawImage && !rawImage.startsWith('http') && !rawImage.startsWith('/')) {
        imageUrl = '/assets/image/product/' + rawImage;
      }

      // 【修复 3】: 使用在线占位图作为兜底，防止本地 default.png 404 导致裂图
      // 这里的 URL 是一个纯灰色的图片
      const fallbackUrl = 'https://via.placeholder.com/300x300/e5e7eb/9ca3af?text=No+Image';

      productHtml += `
          <div class="bg-white rounded-lg overflow-hidden product-card-shadow group flex flex-col h-full">
            <a href="/pages/product/detail.html?id=${product.id}" class="block overflow-hidden relative h-48 bg-gray-100">
              <img
                src="${imageUrl}"
                alt="${product.name}"
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                onerror="this.onerror=null;this.src='${fallbackUrl}'"
              >
            </a>
            <div class="p-4 flex flex-col flex-1">
              <h3 class="text-lg font-medium mb-1 line-clamp-2 h-14" title="${product.name}">
                 <a href="/pages/product/detail.html?id=${product.id}" class="hover:text-primary transition-colors">
                    ${product.name || '未知商品'}
                 </a>
              </h3>
              <div class="mb-3">
                 <div class="text-primary font-bold text-xl">¥${Number(product.price).toFixed(2)}</div>
                 <div class="flex items-center text-yellow-400 text-xs mt-1">
                    ${generateStarRating(product.rating || 5.0)}
                    <span class="text-gray-400 ml-2">(${product.commentCount || 0}条)</span>
                 </div>
              </div>
              <div class="mt-auto flex gap-2">
                 <a href="/pages/product/detail.html?id=${product.id}" class="flex-1 border border-primary text-primary text-center py-1.5 rounded text-sm hover:bg-primary hover:text-white transition-colors">查看详情</a>
                 <button onclick="alert('加入购物车功能需要对接API')" class="px-3 bg-primary text-white rounded hover:bg-opacity-90">
                    <i class="fa fa-shopping-cart"></i>
                 </button>
              </div>
            </div>
          </div>
        `;
    });
    container.innerHTML = productHtml;
  }

  // ================= 以下是保持原有的逻辑功能 =================

  function initFilterFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlCategoryId = urlParams.get('category_id');
    if (urlCategoryId) currentFilter.categoryId = parseInt(urlCategoryId, 10);
    const urlKeyword = urlParams.get('keyword');
    if (urlKeyword) currentFilter.keyword = urlKeyword;
    const urlPromotion = urlParams.get('promotion');
    if (urlPromotion === '1') currentFilter.isPromotion = true;
    const urlPage = urlParams.get('page');
    if (urlPage) pagination.page = parseInt(urlPage, 10);
  }

  function fetchCategoryData() {
    // 这里的 axios 现在因为 CDN 的存在，可以正常工作了
    axios.get('/api/category/list')
            .then(res => {
              if (res.data.code === 200 && res.data.data.length > 0) {
                const categories = res.data.data;
                if (!currentFilter.isPromotion) renderCategoryFilter(categories);
                renderFilterTags(categories);
              }
            })
            .catch(err => console.error(err));
  }

  function fetchProductList() {
    showLoading();
    const params = { page: pagination.page, size: pagination.size };
    if (currentFilter.categoryId) params.category_id = currentFilter.categoryId;
    if (currentFilter.keyword) params.keyword = currentFilter.keyword;
    if (currentFilter.isPromotion) {
      params.is_promotion = 1;
      delete params.category_id;
      delete params.keyword;
    }

    axios.get('/api/product/list', { params })
            .then(res => {
              if (res.data.code === 200) {
                productList = res.data.data.list;
                pagination.total = res.data.data.total;
                pagination.totalPages = res.data.data.totalPages;
                pagination.size = res.data.data.pageSize;
                renderProductList();
                renderPagination();
                showList();
              } else {
                showError(res.data.msg || '数据异常');
              }
            })
            .catch(err => {
              console.error(err); // 现在这里不会报 axios is undefined 了
              showError('网络请求失败');
            });
  }

  /**
   * 渲染左侧分类筛选栏 (已修改：只显示一级分类)
   */
  function renderCategoryFilter(categories) {
    const container = document.getElementById('category-filter');
    // 保留标题
    let html = '<h3 class="font-bold mb-4 border-b pb-2">商品分类</h3><ul class="space-y-2">';

    // 全部分类按钮
    html += `<li><button class="w-full text-left px-3 py-2 rounded transition-colors ${!currentFilter.categoryId ? 'bg-primary text-white shadow-md' : 'hover:bg-gray-100 text-gray-600'}" onclick="changeFilter('categoryId', '')">全部分类</button></li>`;

    categories.forEach(cate => {
      // 【修改点】：增加判断，只渲染 parent_id 为 0 的一级分类
      // 如果后端返回的数据里 parent_id 是数字，就用 === 0
      if (cate.parent_id === 0) {
        const isActive = currentFilter.categoryId == cate.id;
        html += `
              <li>
                <button class="w-full text-left px-3 py-2 rounded transition-colors flex items-center justify-between group ${isActive ? 'bg-primary text-white shadow-md' : 'hover:bg-gray-100 text-gray-600'}" onclick="changeFilter('categoryId', ${cate.id})">
                  <span>${cate.name}</span>
                  ${isActive ? '<i class="fa fa-check text-xs"></i>' : ''}
                </button>
              </li>
            `;
      }
    });
    html += '</ul>';
    container.innerHTML = html;
  }

  /**
   * 渲染顶部筛选标签 (已修改：只显示一级分类)
   */
  function renderFilterTags(categories) {
    const container = document.getElementById('filter-tags');
    let tagHtml = '';
    const isAllActive = !currentFilter.categoryId && !currentFilter.isPromotion;

    tagHtml += `<button class="px-4 py-1.5 rounded-full text-sm transition-colors border ${isAllActive ? 'bg-primary text-white border-primary' : 'bg-white border-gray-200 hover:border-primary hover:text-primary'}" onclick="resetFilterAndFetch()">全部</button>`;

    if (currentFilter.isPromotion) {
      tagHtml += `<button class="px-4 py-1.5 rounded-full text-sm bg-red-100 text-red-600 border border-red-200"><i class="fa fa-fire mr-1"></i> 特惠活动</button>`;
    } else {
      categories.forEach(cate => {
        // 【修改点】：同样增加判断，只渲染一级分类
        if (cate.parent_id === 0) {
          const isActive = currentFilter.categoryId == cate.id;
          tagHtml += `
                  <button class="px-4 py-1.5 rounded-full text-sm transition-colors border ${isActive ? 'bg-primary text-white border-primary' : 'bg-white border-gray-200 hover:border-primary hover:text-primary'}" onclick="changeFilter('categoryId', ${cate.id})">
                    ${cate.name}
                  </button>
                `;
        }
      });
    }
    container.innerHTML = tagHtml;
  }

  function renderPagination() {
    const container = document.getElementById('pagination-container');
    const { totalPages, page } = pagination;
    if (totalPages <= 1) { container.innerHTML = ''; return; }

    let html = '<div class="flex justify-center gap-2">';
    html += `<button class="px-3 py-1 border rounded ${page===1?'opacity-50':''}" onclick="changePage(${page-1})" ${page===1?'disabled':''}>上一页</button>`;
    html += `<span class="px-3 py-1">第 ${page} / ${totalPages} 页</span>`;
    html += `<button class="px-3 py-1 border rounded ${page===totalPages?'opacity-50':''}" onclick="changePage(${page+1})" ${page===totalPages?'disabled':''}>下一页</button>`;
    html += '</div>';
    container.innerHTML = html;
  }

  function resetFilterAndFetch() {
    currentFilter = { categoryId: '', keyword: '', isPromotion: false };
    pagination.page = 1;
    const input = document.querySelector('#header-container input');
    if(input) input.value = '';
    fetchProductList();
  }

  function changeFilter(key, val) {
    if(currentFilter.isPromotion) currentFilter.isPromotion = false;
    currentFilter[key] = (key==='categoryId' && val!=='') ? parseInt(val) : val;
    pagination.page = 1;
    fetchProductList();
  }

  function changePage(p) {
    if(p<1 || p>pagination.totalPages) return;
    pagination.page = p;
    fetchProductList();
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function generateStarRating(r) {
    let html = '';
    for(let i=0; i<5; i++) {
      if(r >= i+1) html += '<i class="fa fa-star"></i>';
      else if(r > i) html += '<i class="fa fa-star-half-o"></i>';
      else html += '<i class="fa fa-star-o"></i>';
    }
    return html;
  }

  function showLoading() {
    document.getElementById('loading-container').classList.remove('hidden');
    document.getElementById('list-container').classList.add('hidden');
    document.getElementById('error-container').classList.add('hidden');
  }
  function showList() {
    document.getElementById('list-container').classList.remove('hidden');
    document.getElementById('loading-container').classList.add('hidden');
    document.getElementById('error-container').classList.add('hidden');
  }
  function showError(msg) {
    document.getElementById('error-container').classList.remove('hidden');
    document.getElementById('error-message').innerText = msg;
    document.getElementById('loading-container').classList.add('hidden');
    document.getElementById('list-container').classList.add('hidden');
  }

  function initHeaderEvents() {
    const input = document.querySelector('#header-container #search-input');
    if (input) {
      if (currentFilter.keyword) input.value = currentFilter.keyword;
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') changeFilter('keyword', input.value.trim());
      });
      document.querySelector('#header-button')?.addEventListener('click', () => {
        changeFilter('keyword', input.value.trim());
      });
    }
  }
</script>
</body>
</html>